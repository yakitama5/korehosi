name: Flutter Build
on:
  workflow_dispatch:
    inputs:
      release_type:
        required: true
        type: choice
        description: ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æŒ‡å®šã—ã¾ã™
        options:
          - all
          - android
          - ios

jobs:
  # Android
  flutter_build_android:
    name: ğŸ¤–Build for Android
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # Androidç”¨ã®ç’°å¢ƒå¤‰æ•°
    env:
      # Google Play èªè¨¼ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ JSON ã‚­ãƒ¼
      GOOGLE_PLAY_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_CREDENTIALS }}

      # Android ç½²åç”¨æƒ…å ±
      ANDROID_KEYSTORE_FILENAME: ${{ vars.ANDROID_KEYSTORE_FILENAME }}
      ANDROID_KEY_ALIAS: ${{ vars.ANDROID_KEY_ALIAS }}
      ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      # Google Play ã‚¢ãƒ—ãƒªã®è¨­å®š
      GOOGLE_PLAY_PACKAGE_NAME: ${{ vars.GOOGLE_PLAY_PACKAGE_NAME }}
    steps:
      # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ’¾Checkout
        uses: actions/checkout@v4

      - name: ğŸª„Install Codemagic CLI tools
        run: pip install codemagic-cli-tools

      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: âš™ï¸Setup Config Files
        uses: ./.github/actions/setup-config-files
        env: # Set the secret as an input
            DART_DEFINE_JSON: ${{ secrets.DART_DEFINE_JSON }}
            FIREBASE_OPTIONS: ${{ secrets.FIREBASE_OPTIONS }}
            FIREBASE_OPTIONS_DEV: ${{ secrets.FIREBASE_OPTIONS_DEV }}
            GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
            GOOGLE_INFO_PLIST: ${{ secrets.GOOGLE_INFO_PLIST }}
            ENV_FILE: ${{ secrets.ENV_FILE }}
            DEV_ENV_FILE: ${{ secrets.DEV_ENV_FILE }}
      - name: âš™ï¸Setup Application Runtime
        uses: ./.github/actions/setup-application-runtime

      # Androidç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š
      - name: âš™ï¸Setup Android keystore
        run: |
          echo "$ANDROID_KEYSTORE" | base64 --decode > apps/app/android/app/$ANDROID_KEYSTORE_FILENAME

      - name: âš™ï¸Create key.properties
        run: |
          cat > apps/app/android/key.properties << EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=$ANDROID_KEYSTORE_FILENAME
          EOF

      # ãƒ“ãƒ«ãƒ‰
      - name: â™»ï¸Regenerate Code
        run: melos run regenerate_code
      - name: ğŸ› ï¸Build for Android
        run: melos run build_app_android

      # ãƒ“ãƒ«ãƒ‰ã—ãŸaabã‚’Github Actionsã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: "ğŸš€Deploy Bundle"
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: apps/app/build/app/outputs/bundle/release/app-release.aab
          retention-days: 7

      - name: ğŸš€Publish to Google Play
        run: |
          google-play bundles publish \
          --bundle "apps/app/build/app/outputs/bundle/release/app-release.aab" \
          --track internal \
          --draft   

  # iOS
  flutter_build_ios:
    if: ${{ false }}
    name: ğŸBuild for iOS
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: ğŸ’¾Checkout
        uses: actions/checkout@v4

      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: âš™ï¸Setup Config Files
        uses: ./.github/actions/setup-config-files
        env: # Set the secret as an input
          DART_DEFINE_JSON: ${{ secrets.DART_DEFINE_JSON }}
          FIREBASE_OPTIONS: ${{ secrets.FIREBASE_OPTIONS }}
          FIREBASE_OPTIONS_DEV: ${{ secrets.FIREBASE_OPTIONS_DEV }}
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_INFO_PLIST: ${{ secrets.GOOGLE_INFO_PLIST }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          DEV_ENV_FILE: ${{ secrets.DEV_ENV_FILE }}
      - name: âš™ï¸Setup Application Runtime
        uses: ./.github/actions/setup-application-runtime

      # ---------------------------------------------------
      - name: "Install codemagic-cli-tools"
        run: |
          pip3 install codemagic-cli-tools --break-system-packages

      - name: "Install the Apple certificate"
        run: |
          echo -n "$CERT_KEY" >> $RUNNER_TEMP/cert_key

      - name: "Install the Apple provisioning profile"
        run: |
          app-store-connect fetch-signing-files "$APP_BUNDLE_ID" \
            --platform $PLATFORM \
            --type IOS_APP_STORE \
            --certificate-key=@file:$RUNNER_TEMP/cert_key \
            --create

      - name: "Install the Certificates"
        run: |
          app-store-connect certificates list \
            --type DISTRIBUTION \
            --certificate-key=@file:$RUNNER_TEMP/cert_key \
            --save

      - name: "keychain initialize"
        run: |
          keychain delete
          keychain initialize

      - name: "keychain add-certificates"
        run: |
          keychain add-certificates

      - name: "xcode-project use-profiles"
        working-directory: packages/mobile
        run: |
          /usr/bin/plutil -replace CFBundleIdentifier -string $APP_BUNDLE_ID ios/Runner/Info.plist
          find **/*.xcodeproj -type f | xargs sed -i "" -E 's/PRODUCT_BUNDLE_IDENTIFIER = ".+";//g'
          xcode-project use-profiles

      - name: Build iOS app
        working-directory: packages/mobile
        run: |
          build_number=$(app-store-connect get-latest-build-number $APPLE_APP_ID --platform=IOS)
          new_build_number=$((build_number + 1))
          echo "$new_build_number"
          flutter build ipa --release \
            --export-options-plist=/Users/runner/export_options.plist \
            --dart-define-from-file=dart_defines/prod.json \
            --build-number=$new_build_number

      # ---------------------------------------------------

      - name: Create ExportOptions
        run: |
          echo -n ${{ secrets.EXPORT_OPTIONS }} | base64 -d > ExportOptions.plist

      # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å–ã‚Šè¾¼ã¿
      - name: Import Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          touch ~/Library/MobileDevice/Provisioning\ Profiles/decoded.mobileprovision
          echo -n '${{ secrets.PROVISIONING_PROFILE }}' | base64 -d -o ~/Library/MobileDevice/Provisioning\ Profiles/decoded.mobileprovision

      # è¨¼æ˜æ›¸ã®å–ã‚Šè¾¼ã¿
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
          p12-password: ${{ secrets.CERTIFICATE_PASSWORD }}

      # ãƒ“ãƒ«ãƒ‰
      - name: â™»ï¸Regenerate Code
        run: melos run regenerate_code
      - name: ğŸ› ï¸Build for iOS
        run: melos run build_app_ios
