name: Flutter Build
on:
  workflow_dispatch:
    inputs:
      release_type:
        required: true
        type: choice
        description: ビルド対象のプラットフォームを指定します
        options:
          - all
          - android
          - ios
jobs:
  # Android
  flutter_build_android:
    name: Build(Android)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      # チェックアウト
      - name: Checkout
        uses: actions/checkout@v4

      # セットアップ
      - name: Setup Config Files
        uses: ./.github/actions/setup-config-files
        env: # Set the secret as an input
          DART_DEFINE_JSON: ${{ secrets.DART_DEFINE_JSON }}
          FIREBASE_OPTIONS: ${{ secrets.FIREBASE_OPTIONS }}
          FIREBASE_OPTIONS_DEV: ${{ secrets.FIREBASE_OPTIONS_DEV }}
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_INFO_PLIST: ${{ secrets.GOOGLE_INFO_PLIST }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          DEV_ENV_FILE: ${{ secrets.DEV_ENV_FILE }}
      - name: Setup Application Runtime
        uses: ./.github/actions/setup-application-runtime

      # Android用の設定ファイルを設定
      - name: Setup Android Config
        uses: ./.github/actions/setup-android-config-files
        env: # Set the secret as an input
          KEY_JKS: ${{ secrets.ANDROID_KEY_JKS }}
          STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

      # ビルド
      - name: Regenerate Code
        run: melos run regenerate_code
      - name: Build for Android
        run: melos run build_app_android

  # iOS
  flutter_build_ios:
    if: ${{ false }}
    name: Build(iOS)
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # セットアップ
      - name: Setup Config Files
        uses: ./.github/actions/setup-config-files
        env: # Set the secret as an input
          DART_DEFINE_JSON: ${{ secrets.DART_DEFINE_JSON }}
          FIREBASE_OPTIONS: ${{ secrets.FIREBASE_OPTIONS }}
          FIREBASE_OPTIONS_DEV: ${{ secrets.FIREBASE_OPTIONS_DEV }}
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_INFO_PLIST: ${{ secrets.GOOGLE_INFO_PLIST }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          DEV_ENV_FILE: ${{ secrets.DEV_ENV_FILE }}
      - name: Setup Application Runtime
        uses: ./.github/actions/setup-application-runtime

      - name: Create ExportOptions
        run: |
          echo -n ${{ secrets.EXPORT_OPTIONS }} | base64 -d > ExportOptions.plist

      # プロビジョニングファイルの取り込み
      - name: Import Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          touch ~/Library/MobileDevice/Provisioning\ Profiles/decoded.mobileprovision
          echo -n '${{ secrets.PROVISIONING_PROFILE }}' | base64 -d -o ~/Library/MobileDevice/Provisioning\ Profiles/decoded.mobileprovision

      # 証明書の取り込み
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
          p12-password: ${{ secrets.CERTIFICATE_PASSWORD }}

      # Build + Upload
      - name: Build for iOS
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          flutter build ipa --export-options-plist=ExportOptions.plist --dart-define-from-file=dart_defines/prod.json
