name: Flutter Build
on:
  workflow_dispatch:
    inputs:
      release_type:
        required: true
        type: choice
        description: ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æŒ‡å®šã—ã¾ã™
        options:
          - all
          - android
          - ios
jobs:
  # Android
  flutter_build_android:
    name: ğŸ¤–Build for Android
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ’¾Checkout
        uses: actions/checkout@v4

      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: âš™ï¸Setup Config Files
        uses: ./.github/actions/setup-config-files
        env: # Set the secret as an input
          DART_DEFINE_JSON: ${{ secrets.DART_DEFINE_JSON }}
          FIREBASE_OPTIONS: ${{ secrets.FIREBASE_OPTIONS }}
          FIREBASE_OPTIONS_DEV: ${{ secrets.FIREBASE_OPTIONS_DEV }}
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_INFO_PLIST: ${{ secrets.GOOGLE_INFO_PLIST }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          DEV_ENV_FILE: ${{ secrets.DEV_ENV_FILE }}
      - name: âš™ï¸Setup Application Runtime
        uses: ./.github/actions/setup-application-runtime

      # Androidç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š
      - name: âš™ï¸Setup Android Config
        uses: ./.github/actions/setup-android-config-files
        env: # Set the secret as an input
          KEY_JKS: ${{ secrets.ANDROID_KEY_JKS }}
          STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

      # ãƒ“ãƒ«ãƒ‰
      - name: â™»ï¸Regenerate Code
        run: melos run regenerate_code
      - name: ğŸ› ï¸Build for Android
        run: melos run build_app_android

    # ãƒ“ãƒ«ãƒ‰ã—ãŸaabã‚’Github Actionsã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: "ğŸš€Deploy Bundle"
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 7

  # iOS
  flutter_build_ios:
    if: ${{ false }}
    name: ğŸBuild for iOS
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Config Files
        uses: ./.github/actions/setup-config-files
        env: # Set the secret as an input
          DART_DEFINE_JSON: ${{ secrets.DART_DEFINE_JSON }}
          FIREBASE_OPTIONS: ${{ secrets.FIREBASE_OPTIONS }}
          FIREBASE_OPTIONS_DEV: ${{ secrets.FIREBASE_OPTIONS_DEV }}
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_INFO_PLIST: ${{ secrets.GOOGLE_INFO_PLIST }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          DEV_ENV_FILE: ${{ secrets.DEV_ENV_FILE }}
      - name: Setup Application Runtime
        uses: ./.github/actions/setup-application-runtime

      - name: Create ExportOptions
        run: |
          echo -n ${{ secrets.EXPORT_OPTIONS }} | base64 -d > ExportOptions.plist

      # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å–ã‚Šè¾¼ã¿
      - name: Import Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          touch ~/Library/MobileDevice/Provisioning\ Profiles/decoded.mobileprovision
          echo -n '${{ secrets.PROVISIONING_PROFILE }}' | base64 -d -o ~/Library/MobileDevice/Provisioning\ Profiles/decoded.mobileprovision

      # è¨¼æ˜æ›¸ã®å–ã‚Šè¾¼ã¿
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
          p12-password: ${{ secrets.CERTIFICATE_PASSWORD }}

      # Build + Upload
      - name: Build for iOS
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          flutter build ipa --export-options-plist=ExportOptions.plist --dart-define-from-file=dart_defines/prod.json
