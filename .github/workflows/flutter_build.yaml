name: Flutter Build
on:
  workflow_dispatch:
    inputs:
      release_type:
        required: true
        type: choice
        description: ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æŒ‡å®šã—ã¾ã™
        options:
          - all
          - android
          - ios

jobs:
  # Android
  flutter_build_android:
    if: ${{ github.event.inputs.release_type == 'android' || github.event.inputs.release_type == 'all'}}
    name: ğŸ¤–Build for Android
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # Androidç”¨ã®ç’°å¢ƒå¤‰æ•°
    env:
      # Google Play èªè¨¼ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ JSON ã‚­ãƒ¼
      GOOGLE_PLAY_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_CREDENTIALS }}

      # Android ç½²åç”¨æƒ…å ±
      ANDROID_KEYSTORE_FILENAME: ${{ vars.ANDROID_KEYSTORE_FILENAME }}
      ANDROID_KEY_ALIAS: ${{ vars.ANDROID_KEY_ALIAS }}
      ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      # Google Play ã‚¢ãƒ—ãƒªã®è¨­å®š
      GOOGLE_PLAY_PACKAGE_NAME: ${{ vars.GOOGLE_PLAY_PACKAGE_NAME }}
    steps:
      # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ’¾Checkout
        uses: actions/checkout@v4

      - name: ğŸª„Install Codemagic CLI tools
        run: pip install codemagic-cli-tools

      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: âš™ï¸Setup Config Files
        uses: ./.github/actions/setup-config-files
        env: # Set the secret as an input
          DART_DEFINE_JSON: ${{ secrets.DART_DEFINE_JSON }}
          FIREBASE_OPTIONS: ${{ secrets.FIREBASE_OPTIONS }}
          FIREBASE_OPTIONS_DEV: ${{ secrets.FIREBASE_OPTIONS_DEV }}
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_INFO_PLIST: ${{ secrets.GOOGLE_INFO_PLIST }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          DEV_ENV_FILE: ${{ secrets.DEV_ENV_FILE }}
      - name: âš™ï¸Setup Application Runtime
        uses: ./.github/actions/setup-application-runtime

      # Androidç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š
      - name: âš™ï¸Setup Android keystore
        run: |
          echo "$ANDROID_KEYSTORE" | base64 --decode > apps/app/android/app/$ANDROID_KEYSTORE_FILENAME

      - name: âš™ï¸Create key.properties
        run: |
          cat > apps/app/android/key.properties << EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=$ANDROID_KEYSTORE_FILENAME
          EOF

      # ãƒ“ãƒ«ãƒ‰
      - name: â™»ï¸Regenerate Code
        run: melos run regenerate_code
      - name: ğŸ› ï¸Build for Android
        run: melos run build_app_android

      # ãƒ“ãƒ«ãƒ‰ã—ãŸaabã‚’Github Actionsã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: "ğŸš€Deploy Bundle"
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: apps/app/build/app/outputs/bundle/release/app-release.aab
          retention-days: 7

      - name: ğŸš€Publish to Google Play
        run: |
          google-play bundles publish \
          --bundle "apps/app/build/app/outputs/bundle/release/app-release.aab" \
          --track internal \

  # iOS
  flutter_build_ios:
    if: ${{ github.event.inputs.release_type == 'ios' || github.event.inputs.release_type == 'all'}}
    name: ğŸBuild for iOS
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      APP_STORE_CONNECT_ISSUER_ID: ${{ vars.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ vars.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      DIST_CERTIFICATE: ${{ secrets.CERTIFICATES_P12 }}
      DIST_CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
      DIST_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      APP_STORE_APPLE_ID: ${{ vars.APP_STORE_APPLE_ID }}
      EXPORT_OPTIONS: ${{ secrets.EXPORT_OPTIONS }}
    steps:
      # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ’¾Checkout
        uses: actions/checkout@v4

      - name: ğŸª„Install Codemagic CLI tools
        run: pip install codemagic-cli-tools

      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: âš™ï¸Setup Config Files
        uses: ./.github/actions/setup-config-files
        env: # Set the secret as an input
          DART_DEFINE_JSON: ${{ secrets.DART_DEFINE_JSON }}
          FIREBASE_OPTIONS: ${{ secrets.FIREBASE_OPTIONS }}
          FIREBASE_OPTIONS_DEV: ${{ secrets.FIREBASE_OPTIONS_DEV }}
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_INFO_PLIST: ${{ secrets.GOOGLE_INFO_PLIST }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          DEV_ENV_FILE: ${{ secrets.DEV_ENV_FILE }}
      - name: âš™ï¸Setup Application Runtime
        uses: ./.github/actions/setup-application-runtime

      - name: âš™ï¸Set up keychain
        run: keychain initialize

      - name: âš™ï¸Set up Provisioning profiles
        run: |
          PROFILES_HOME="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILES_HOME"
          PROFILE_PATH="$(mktemp "$PROFILES_HOME"/$(uuidgen).mobileprovision)"
          echo ${DIST_PROFILE} | base64 --decode > "$PROFILE_PATH"
          echo "Saved provisioning profile $PROFILE_PATH"
      - name: âš™ï¸Set up signing certificate
        run: |
          echo $DIST_CERTIFICATE | base64 --decode > /tmp/certificate.p12
          keychain add-certificates --certificate /tmp/certificate.p12 --certificate-password $DIST_CERTIFICATE_PASSWORD

      - name: âš™ï¸Set up code signing settings on Xcode project
        run: xcode-project use-profiles

      - name: âš™ï¸Create ExportOptions
        run: |
          echo -n $EXPORT_OPTIONS | base64 -d > apps/app/ExportOptions.plist

      - name: â™»ï¸Regenerate Code
        run: melos run regenerate_code
      - name: ğŸ› ï¸Build for iOS
        run: |
          melos run build_app_ios

      - name: ğŸš€Publish the app to App Store Connect
        run: |
          APP_FILE=$(find $(pwd) -name "*.ipa")
          app-store-connect publish \
          --path "$APP_FILE"
